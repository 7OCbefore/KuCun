<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>智能出库管理 Pro V5</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. SheetJS (Excel导出) -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <!-- 4. HTML5-QRCode -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #F2F2F7;
            color: #1C1C1E;
            overscroll-behavior: none;
        }
        
        /* 动画定义 */
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        .animate-scale-up { animation: scaleUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .pt-safe-top { padding-top: env(safe-area-inset-top); }
        .pb-safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        /* 行高亮闪烁动画 */
        @keyframes flashRow {
            0% { background-color: rgba(59, 130, 246, 0.2); }
            50% { background-color: rgba(59, 130, 246, 0.1); }
            100% { background-color: transparent; }
        }
        .row-highlight { animation: flashRow 1s ease-out; }

        /* 扫描线动画 */
        @keyframes scanLine {
            0% { transform: translateY(0); opacity: 0.5; }
            50% { opacity: 1; }
            100% { transform: translateY(200px); opacity: 0.5; }
        }
        .scan-laser {
            width: 100%;
            height: 2px;
            background: #3b82f6;
            box-shadow: 0 0 4px #3b82f6;
            animation: scanLine 2s infinite linear;
        }

        /* 修复扫描视频比例 */
        #reader video { 
            object-fit: cover; 
            width: 100% !important;
            height: 100% !important;
            border-radius: 12px; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- 图标组件 ---
        const Icons = {
            Package: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>,
            Scan: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></svg>,
            Save: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
            History: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20v-6M6 20V10M18 20V4"/></svg>,
            Trash: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            Plus: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Minus: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            X: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Share: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>,
            Copy: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
            ChevronLeft: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>,
            ChevronRight: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>,
            Info: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>,
            AlertTriangle: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>,
            TrendingUp: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>,
            List: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
        };

        // --- 全屏扫描器 ---
        const FullScreenScanner = ({ onScan, onClose, show }) => {
            const videoRef = useRef(null);
            const html5QrCodeRef = useRef(null);
            const isNativeSupportedRef = useRef(false);

            useEffect(() => {
                if (!show) return;
                const startScanner = async () => {
                    if ('BarcodeDetector' in window) {
                        try {
                            const formats = await window.BarcodeDetector.getSupportedFormats();
                            if (formats.includes('qr_code')) {
                                isNativeSupportedRef.current = true;
                                startNativeScanner();
                                return;
                            }
                        } catch (e) {}
                    }
                    startWasmScanner();
                };
                startScanner();
                return () => {
                    if (html5QrCodeRef.current) html5QrCodeRef.current.stop().catch(()=>{});
                    if (videoRef.current && videoRef.current.srcObject) videoRef.current.srcObject.getTracks().forEach(t => t.stop());
                };
            }, [show]);

            const startNativeScanner = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        await videoRef.current.play();
                        const detector = new window.BarcodeDetector({ formats: ['qr_code', 'ean_13', 'code_128'] });
                        const detectLoop = async () => {
                            if (!videoRef.current) return;
                            try {
                                const barcodes = await detector.detect(videoRef.current);
                                if (barcodes.length > 0) onScan(barcodes[0].rawValue);
                            } catch (e) {}
                            requestAnimationFrame(detectLoop);
                        };
                        detectLoop();
                    }
                } catch (e) { startWasmScanner(); }
            };

            const startWasmScanner = () => {
                const scanner = new Html5Qrcode("reader-container");
                html5QrCodeRef.current = scanner;
                const boxSize = Math.min(window.innerWidth * 0.7, 280);
                scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: boxSize, height: boxSize } }, onScan, ()=>{});
            };

            if (!show) return null;

            return (
                <div className="fixed inset-0 z-[999] bg-black flex flex-col">
                    <div className="absolute top-0 left-0 right-0 p-4 pt-safe-top z-20 flex justify-between bg-black/40 backdrop-blur-sm">
                        <button onClick={onClose} className="p-2 bg-white/20 rounded-full text-white"><Icons.X /></button>
                        <div className="text-white text-sm font-bold">扫描条码</div>
                    </div>
                    {isNativeSupportedRef.current ? 
                        <video ref={videoRef} className="absolute inset-0 w-full h-full object-cover"></video> : 
                        <div id="reader-container" className="absolute inset-0 w-full h-full"></div>
                    }
                    <div className="absolute inset-0 pointer-events-none z-10 flex flex-col">
                        <div className="flex-1 bg-black/50"></div>
                        <div className="flex h-[280px] w-full">
                            <div className="flex-1 bg-black/50"></div>
                            <div className="w-[280px] h-[280px] border-2 border-blue-500 relative bg-transparent box-content">
                                <div className="scan-laser absolute top-0 left-0"></div>
                            </div>
                            <div className="flex-1 bg-black/50"></div>
                        </div>
                        <div className="flex-1 bg-black/50 flex flex-col items-center pt-8">
                            <p className="text-white/90 text-sm font-medium">扫一扫，自动返回确认</p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 智能输入联想组件 ---
        const SmartInput = ({ onAdd, productDB, manualCode, setManualCode }) => {
            const [suggestions, setSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);

            useEffect(() => {
                if (!manualCode.trim()) {
                    setSuggestions([]);
                    return;
                }
                const query = manualCode.toLowerCase();
                const dbArray = Object.entries(productDB).map(([code, info]) => ({code, ...info}));
                // 搜索名称 或 条码
                const matched = dbArray.filter(item => 
                    (item.name && item.name.toLowerCase().includes(query)) || 
                    item.code.includes(query)
                ).slice(0, 5); // 最多显示5条
                setSuggestions(matched);
                setShowSuggestions(matched.length > 0);
            }, [manualCode, productDB]);

            const handleSelect = (item) => {
                onAdd(item.code); // 直接添加
                setManualCode(''); // 清空输入
                setShowSuggestions(false);
            };

            return (
                <div className="relative flex-1 z-20">
                    <input 
                        type="text" 
                        className="w-full bg-gray-100 rounded-lg px-3 text-sm outline-none h-10 focus:ring-2 focus:ring-blue-100 transition-all"
                        placeholder="输入商品名或条码..."
                        value={manualCode}
                        onChange={e => { setManualCode(e.target.value); setShowSuggestions(true); }}
                        onFocus={() => { if(manualCode) setShowSuggestions(true); }}
                        onBlur={() => setTimeout(() => setShowSuggestions(false), 200)} // 延迟关闭以便点击
                    />
                    {showSuggestions && suggestions.length > 0 && (
                        <div className="absolute top-full left-0 right-0 mt-1 bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden animate-fade-in">
                            <div className="bg-gray-50 px-3 py-1 text-[10px] text-gray-400 font-bold uppercase tracking-wider">联想推荐</div>
                            {suggestions.map((item) => (
                                <div key={item.code} 
                                    className="p-3 border-b border-gray-50 last:border-0 hover:bg-blue-50 cursor-pointer flex justify-between items-center"
                                    onMouseDown={(e) => { e.preventDefault(); handleSelect(item); }} // 使用MouseDown避免Blur先触发
                                >
                                    <div>
                                        <div className="font-bold text-sm text-gray-800">{item.name || '未命名'}</div>
                                        <div className="text-xs text-gray-400 font-mono">{item.code}</div>
                                    </div>
                                    <div className="text-blue-600 text-xs font-bold bg-blue-50 px-2 py-1 rounded">
                                        + 添加
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- 确认弹窗 & Toast ---
        const ConfirmModal = ({ isOpen, title, content, onConfirm, onCancel, confirmText="确认", cancelText="取消", isDangerous=false }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center p-6 animate-fade-in">
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onCancel}></div>
                    <div className="bg-white rounded-2xl w-full max-w-xs p-6 relative z-10 shadow-2xl animate-scale-up">
                        <div className={`mx-auto w-12 h-12 rounded-full flex items-center justify-center mb-4 ${isDangerous ? 'bg-red-50 text-red-500' : 'bg-blue-50 text-blue-500'}`}>
                            {isDangerous ? <Icons.AlertTriangle /> : <Icons.Info />}
                        </div>
                        <h3 className="text-lg font-bold text-gray-900 text-center mb-2">{title}</h3>
                        <p className="text-sm text-gray-500 text-center mb-6 leading-relaxed">{content}</p>
                        <div className="flex gap-3">
                            <button onClick={onCancel} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl text-sm">{cancelText}</button>
                            <button onClick={onConfirm} className={`flex-1 py-3 text-white font-bold rounded-xl shadow-lg text-sm ${isDangerous ? 'bg-red-500 shadow-red-200' : 'bg-blue-600 shadow-blue-200'}`}>{confirmText}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Toast = ({ show, message, type = 'success' }) => {
            if (!show) return null;
            return (
                <div className="fixed top-20 left-1/2 transform -translate-x-1/2 z-[1100] animate-fade-in pointer-events-none">
                    <div className={`px-5 py-2.5 rounded-full shadow-xl flex items-center gap-2 text-sm font-bold text-white backdrop-blur-md ${type === 'success' ? 'bg-black/80' : 'bg-red-500/90'}`}>
                        {type === 'success' ? <Icons.Info size={16}/> : <Icons.AlertTriangle size={16}/>}
                        {message}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [currentOrder, setCurrentOrder] = useState(() => JSON.parse(localStorage.getItem('inventory_current_order')) || []);
            const [orderHistory, setOrderHistory] = useState(() => JSON.parse(localStorage.getItem('inventory_history')) || []);
            const [productDB, setProductDB] = useState(() => JSON.parse(localStorage.getItem('inventory_db')) || {});

            const [activeTab, setActiveTab] = useState('current');
            const [showScanner, setShowScanner] = useState(false);
            const [lastScannedCode, setLastScannedCode] = useState(null);
            const [manualCode, setManualCode] = useState("");
            
            // 统计页状态
            const [statsMode, setStatsMode] = useState('list'); // 'list' (历史列表) 或 'item_stats' (单品统计)

            const [modalConfig, setModalConfig] = useState({ isOpen: false });
            const [toastConfig, setToastConfig] = useState({ show: false, message: '', type: 'success' });
            const [viewingOrderId, setViewingOrderId] = useState(null);

            useEffect(() => { localStorage.setItem('inventory_current_order', JSON.stringify(currentOrder)); }, [currentOrder]);
            useEffect(() => { localStorage.setItem('inventory_history', JSON.stringify(orderHistory)); }, [orderHistory]);
            useEffect(() => { localStorage.setItem('inventory_db', JSON.stringify(productDB)); }, [productDB]);

            const showToast = (msg, type = 'success') => {
                setToastConfig({ show: true, message: msg, type });
                setTimeout(() => setToastConfig(prev => ({ ...prev, show: false })), 2000);
            };

            const addItemToOrder = (code) => {
                const now = Date.now();
                const existingIndex = currentOrder.findIndex(item => item.code === code);
                if (existingIndex !== -1) {
                    const newOrder = [...currentOrder];
                    newOrder[existingIndex].qty += 1;
                    setCurrentOrder(newOrder);
                } else {
                    const productInfo = productDB[code] || { name: "", price: 0 };
                    const newItem = { id: now, code: code, name: productInfo.name, price: productInfo.price, qty: 1 };
                    setCurrentOrder([newItem, ...currentOrder]);
                }
                setLastScannedCode(code);
                setTimeout(() => setLastScannedCode(null), 1000);
                if (navigator.vibrate) navigator.vibrate(50);
                const audio = new Audio('https://www.soundjay.com/buttons/sounds/button-3.mp3');
                audio.play().catch(()=>{});
                showToast(`已添加: ${productDB[code]?.name || code}`);
            };

            const onScanSuccess = (decodedText) => {
                addItemToOrder(decodedText);
                setShowScanner(false); // 扫码成功后立即关闭
            };

            const updateCurrentItem = (id, field, value) => {
                setCurrentOrder(prev => prev.map(item => {
                    if (item.id === id) {
                        const updated = { ...item, [field]: value };
                        if (field === 'name' || field === 'price') {
                            setTimeout(() => setProductDB(prevDB => ({ ...prevDB, [updated.code]: { name: updated.name, price: Number(updated.price) } })), 0);
                        }
                        return updated;
                    }
                    return item;
                }));
            };

            const deleteCurrentItem = (id) => {
                setModalConfig({
                    isOpen: true, title: "删除商品", content: "确定移除此商品吗？", isDangerous: true,
                    onConfirm: () => { setCurrentOrder(prev => prev.filter(item => item.id !== id)); setModalConfig({isOpen:false}); },
                    onCancel: () => setModalConfig({isOpen:false})
                });
            };

            const saveCurrentOrder = () => {
                if (currentOrder.length === 0) return showToast("清单为空", "error");
                setModalConfig({
                    isOpen: true, title: "确认归档", content: `共 ${currentOrder.length} 项商品，即将保存。`,
                    onConfirm: () => {
                        const totalQty = currentOrder.reduce((sum, i) => sum + i.qty, 0);
                        const totalAmount = currentOrder.reduce((sum, i) => sum + (i.price * i.qty), 0);
                        setOrderHistory([{ id: Date.now(), date: Date.now(), totalQty, totalAmount, items: [...currentOrder] }, ...orderHistory]);
                        setCurrentOrder([]); setShowScanner(false); setModalConfig({isOpen:false}); showToast("归档成功");
                    },
                    onCancel: () => setModalConfig({isOpen:false})
                });
            };

            // --- 单品统计逻辑 ---
            const itemStats = useMemo(() => {
                const stats = {};
                const now = new Date();
                const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
                const startOfYear = new Date(now.getFullYear(), 0, 1).getTime();

                orderHistory.forEach(order => {
                    order.items.forEach(item => {
                        const key = item.name || item.code; // 优先按名称聚合
                        if (!stats[key]) stats[key] = { name: key, code: item.code, today: 0, month: 0, year: 0 };
                        const qty = Number(item.qty);
                        if (order.date >= startOfDay) stats[key].today += qty;
                        if (order.date >= startOfMonth) stats[key].month += qty;
                        if (order.date >= startOfYear) stats[key].year += qty;
                    });
                });
                return Object.values(stats).sort((a,b) => b.today - a.today); // 按今日数量排序
            }, [orderHistory]);

            // --- 编辑历史 ---
            const viewingOrder = useMemo(() => orderHistory.find(o => o.id === viewingOrderId), [orderHistory, viewingOrderId]);
            
            const updateHistoryItem = (itemId, field, value) => {
                if (!viewingOrder) return;
                const updatedItems = viewingOrder.items.map(item => item.id === itemId ? { ...item, [field]: value } : item);
                const totalQty = updatedItems.reduce((s, i) => s + Number(i.qty), 0);
                const totalAmount = updatedItems.reduce((s, i) => s + (Number(i.price) * Number(i.qty)), 0);
                setOrderHistory(prev => prev.map(o => o.id === viewingOrderId ? { ...o, items: updatedItems, totalQty, totalAmount } : o));
            };

            const deleteHistoryItem = (itemId) => {
                setModalConfig({ isOpen: true, title: "删除条目", content: "确定删除?", isDangerous: true,
                    onConfirm: () => {
                        const updatedItems = viewingOrder.items.filter(item => item.id !== itemId);
                        const totalQty = updatedItems.reduce((s, i) => s + Number(i.qty), 0);
                        const totalAmount = updatedItems.reduce((s, i) => s + (Number(i.price) * Number(i.qty)), 0);
                        setOrderHistory(prev => prev.map(o => o.id === viewingOrderId ? { ...o, items: updatedItems, totalQty, totalAmount } : o));
                        setModalConfig({isOpen:false});
                    }, onCancel: () => setModalConfig({isOpen:false})
                });
            };

            const deleteHistoryOrder = () => {
                setModalConfig({ isOpen: true, title: "删除整单", content: "无法撤销，确定吗？", isDangerous: true,
                    onConfirm: () => { setOrderHistory(prev => prev.filter(o => o.id !== viewingOrderId)); setViewingOrderId(null); setModalConfig({isOpen:false}); showToast("已删除"); },
                    onCancel: () => setModalConfig({isOpen:false})
                });
            };

            // --- 导出 ---
            const copyOrderText = (orderItems, dateStr="当前") => {
                let text = `出库单 (${dateStr})\n----------------\n`;
                orderItems.forEach(item => text += `${item.name||item.code} x${item.qty}\n`);
                text += `----------------\n总数量: ${orderItems.reduce((s,i)=>s+Number(i.qty),0)}`;
                const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast("已复制");
            };
            const exportOrderExcel = (orderItems, filename) => {
                const data = orderItems.map(i => ({"条码":i.code, "名称":i.name, "数量":i.qty, "单价":i.price, "小计":(i.price*i.qty).toFixed(2)}));
                data.push({"条码":"总计", "数量":orderItems.reduce((s,i)=>s+Number(i.qty),0), "小计":orderItems.reduce((s,i)=>s+(i.price*i.qty),0).toFixed(2)});
                const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1"); XLSX.writeFile(wb, filename+".xlsx");
            };

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col pb-20 max-w-lg mx-auto shadow-2xl relative overflow-hidden">
                    <ConfirmModal {...modalConfig} />
                    <Toast {...toastConfig} />
                    <FullScreenScanner show={showScanner} onScan={onScanSuccess} onClose={() => setShowScanner(false)} />

                    {/* 顶部栏 */}
                    <div className="bg-white border-b border-gray-200 sticky top-0 z-30 pt-safe-top">
                        <div className="px-4 h-14 flex items-center justify-between">
                            <h1 className="font-bold text-lg text-slate-800">
                                {activeTab === 'current' ? '出库开单' : '数据中心'}
                            </h1>
                            
                            {activeTab === 'current' && (
                                <button onClick={() => setShowScanner(true)} className="flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-bold transition-colors bg-blue-100 text-blue-600">
                                    <Icons.Scan size={16} /> 扫一扫
                                </button>
                            )}

                            {activeTab === 'history' && (
                                <div className="flex bg-gray-100 rounded-lg p-0.5">
                                    <button onClick={()=>setStatsMode('list')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${statsMode==='list'?'bg-white shadow text-black':'text-gray-500'}`}>记录</button>
                                    <button onClick={()=>setStatsMode('item_stats')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${statsMode==='item_stats'?'bg-white shadow text-black':'text-gray-500'}`}>统计</button>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto">
                        
                        {/* Tab 1: 开单 */}
                        {activeTab === 'current' && (
                            <div className="flex flex-col min-h-full">
                                <div className="p-3 bg-white border-b border-gray-100 flex gap-2 items-center">
                                    {/* 智能联想输入框 */}
                                    <SmartInput 
                                        manualCode={manualCode} 
                                        setManualCode={setManualCode} 
                                        productDB={productDB} 
                                        onAdd={addItemToOrder}
                                    />
                                    <button onClick={() => {if(manualCode) {addItemToOrder(manualCode); setManualCode('');}}} className="bg-blue-600 text-white px-4 h-10 rounded-lg font-bold text-sm shadow-sm active:scale-95 transition-transform">
                                        添加
                                    </button>
                                </div>

                                <div className="p-3 space-y-3 pb-32">
                                    {currentOrder.length === 0 ? (
                                        <div className="flex flex-col items-center justify-center py-10 text-gray-400 gap-2">
                                            <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-2"><Icons.Scan size={30} className="opacity-30"/></div>
                                            <div className="text-sm text-center">点击右上角“扫一扫”<br/>或在上方输入名称/条码</div>
                                        </div>
                                    ) : (
                                        currentOrder.map(item => (
                                            <div key={item.id} className={`bg-white rounded-xl p-3 shadow-sm border border-gray-100 transition-colors duration-500 ${lastScannedCode === item.code ? 'row-highlight ring-2 ring-blue-400 border-blue-400' : ''}`}>
                                                <div className="flex justify-between items-start mb-2">
                                                    <div className="flex-1 mr-2">
                                                        <input type="text" className="font-bold text-base w-full outline-none bg-transparent text-slate-800" placeholder="点击输入名称..." value={item.name} onChange={e => updateCurrentItem(item.id, 'name', e.target.value)} />
                                                        <div className="text-xs text-gray-400 font-mono mt-0.5">{item.code}</div>
                                                    </div>
                                                    <button onClick={() => deleteCurrentItem(item.id)} className="text-gray-300 p-1 hover:text-red-500"><Icons.Trash /></button>
                                                </div>
                                                <div className="flex justify-between items-center bg-gray-50 p-2 rounded-lg">
                                                    <div className="flex items-center gap-1"><span className="text-gray-400 text-xs">¥</span><input type="number" className="w-16 bg-transparent font-bold text-slate-700 outline-none" value={item.price} onChange={e => updateCurrentItem(item.id, 'price', e.target.value)} placeholder="0.00" /></div>
                                                    <div className="flex items-center gap-3">
                                                        <button className="w-6 h-6 bg-white border rounded flex items-center justify-center active:bg-gray-200" onClick={() => updateCurrentItem(item.id, 'qty', Math.max(1, item.qty - 1))}><Icons.Minus size={14}/></button>
                                                        <span className="font-bold text-lg w-6 text-center">{item.qty}</span>
                                                        <button className="w-6 h-6 bg-white border rounded flex items-center justify-center active:bg-gray-200" onClick={() => updateCurrentItem(item.id, 'qty', item.qty + 1)}><Icons.Plus size={14}/></button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Tab 2: 历史 & 统计 */}
                        {activeTab === 'history' && (
                            <div className="p-4 space-y-4 pb-24 animate-fade-in">
                                
                                {/* 模式一：历史单据列表 */}
                                {statsMode === 'list' && (
                                    <div className="space-y-3">
                                        <div className="text-xs font-bold text-gray-400 pl-1 uppercase tracking-wider">最近出库单</div>
                                        {orderHistory.length === 0 ? <div className="text-center text-gray-400 text-xs py-10">暂无记录</div> : 
                                            orderHistory.sort((a,b)=>b.date-a.date).map(order => (
                                            <div key={order.id} onClick={() => setViewingOrderId(order.id)} className="bg-white rounded-xl p-4 shadow-sm border border-gray-100 active:bg-gray-50 transition-colors cursor-pointer flex justify-between items-center">
                                                <div>
                                                    <div className="font-bold text-slate-700 text-sm">{new Date(order.date).toLocaleString()}</div>
                                                    <div className="text-xs text-gray-400 mt-1">共 {order.totalQty} 件商品</div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="font-bold text-slate-800 text-sm">¥ {order.totalAmount.toFixed(2)}</div>
                                                    <Icons.ChevronRight className="text-gray-300 inline-block ml-1" size={16} />
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {/* 模式二：单品统计视图 */}
                                {statsMode === 'item_stats' && (
                                    <div className="space-y-3">
                                        <div className="bg-blue-50 p-3 rounded-xl border border-blue-100 text-xs text-blue-700 mb-4">
                                            <Icons.TrendingUp size={14} className="inline mr-1"/>
                                            实时统计各商品的累计出库数量
                                        </div>
                                        {itemStats.map((stat, idx) => (
                                            <div key={idx} className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                                                <div className="flex justify-between items-start mb-3 border-b border-gray-50 pb-2">
                                                    <div>
                                                        <div className="font-bold text-slate-800">{stat.name || '未命名商品'}</div>
                                                        <div className="text-xs text-gray-400 font-mono">{stat.code}</div>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-3 gap-2 text-center">
                                                    <div className="bg-gray-50 rounded-lg p-2">
                                                        <div className="text-xs text-gray-500 mb-1">今日</div>
                                                        <div className={`font-bold text-lg ${stat.today>0?'text-blue-600':'text-gray-300'}`}>{stat.today}</div>
                                                    </div>
                                                    <div className="bg-gray-50 rounded-lg p-2">
                                                        <div className="text-xs text-gray-500 mb-1">本月</div>
                                                        <div className={`font-bold text-lg ${stat.month>0?'text-slate-700':'text-gray-300'}`}>{stat.month}</div>
                                                    </div>
                                                    <div className="bg-gray-50 rounded-lg p-2">
                                                        <div className="text-xs text-gray-500 mb-1">本年</div>
                                                        <div className={`font-bold text-lg ${stat.year>0?'text-slate-700':'text-gray-300'}`}>{stat.year}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        {itemStats.length === 0 && <div className="text-center text-gray-400 text-xs py-10">暂无统计数据</div>}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* 底部结算栏 */}
                    {activeTab === 'current' && (
                        <div className="absolute bottom-16 left-4 right-4 bg-white/90 backdrop-blur-md border border-gray-200 shadow-lg rounded-2xl p-3 pb-safe-bottom z-40 animate-slide-up">
                            <div className="flex justify-between items-center mb-3 px-1">
                                <span className="text-sm text-gray-500 font-medium">本单合计</span>
                                <span className="text-xl font-bold text-red-600">¥ {currentOrder.reduce((s,i)=>s+(i.price*i.qty),0).toFixed(2)}</span>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => copyOrderText(currentOrder)} className="flex-1 py-3 bg-blue-50 text-blue-600 font-bold rounded-xl flex items-center justify-center gap-1 text-sm"><Icons.Copy size={16} /> 复制</button>
                                <button onClick={() => exportOrderExcel(currentOrder, `出库单_${Date.now()}`)} className="w-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center"><Icons.Share size={16} /></button>
                                <button onClick={saveCurrentOrder} className="flex-[1.5] py-3 bg-blue-600 text-white font-bold rounded-xl flex items-center justify-center gap-1 shadow-lg shadow-blue-500/30 text-sm"><Icons.Save size={16} /> 归档</button>
                            </div>
                        </div>
                    )}

                    {/* 底部导航 */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 pb-safe-bottom z-50 h-16 flex items-center justify-around max-w-lg mx-auto">
                        <button onClick={() => setActiveTab('current')} className={`flex flex-col items-center gap-1 w-16 ${activeTab === 'current' ? 'text-blue-600' : 'text-gray-400'}`}><Icons.Package size={24} /><span className="text-[10px] font-medium">开单</span></button>
                        <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center gap-1 w-16 ${activeTab === 'history' ? 'text-blue-600' : 'text-gray-400'}`}><Icons.History size={24} /><span className="text-[10px] font-medium">记录</span></button>
                    </div>
                    
                    {/* 详情页 */}
                    {viewingOrder && (
                        <div className="fixed inset-0 z-[60] bg-gray-100 flex flex-col animate-slide-up">
                            <div className="bg-white px-4 h-14 border-b flex items-center justify-between pt-safe-top shrink-0">
                                <button onClick={() => setViewingOrderId(null)} className="text-blue-600 font-bold text-sm flex items-center"><Icons.ChevronLeft size={20}/> 返回</button>
                                <span className="font-bold text-sm">单据详情</span>
                                <div className="flex gap-3"><button onClick={() => copyOrderText(viewingOrder.items)} className="text-blue-600"><Icons.Copy size={20}/></button><button onClick={() => exportOrderExcel(viewingOrder.items, `历史_${viewingOrder.id}`)} className="text-green-600"><Icons.Share size={20}/></button></div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 pb-32 space-y-3">
                                {viewingOrder.items.map(item => (
                                    <div key={item.id} className="bg-white rounded-xl p-3 shadow-sm border border-gray-100">
                                        <div className="flex justify-between items-start mb-2"><div className="flex-1"><div className="font-bold text-slate-800">{item.name}</div><div className="text-xs text-gray-400">{item.code}</div></div><button onClick={() => deleteHistoryItem(item.id)} className="text-gray-300"><Icons.Trash size={18}/></button></div>
                                        <div className="flex justify-between items-center bg-gray-50 p-2 rounded-lg"><div className="text-xs text-gray-500">¥ {item.price}</div><div className="flex items-center gap-3"><button onClick={() => updateHistoryItem(item.id, 'qty', Math.max(1, item.qty-1))}><Icons.Minus size={14}/></button><span className="font-bold">{item.qty}</span><button onClick={() => updateHistoryItem(item.id, 'qty', item.qty+1)}><Icons.Plus size={14}/></button></div></div>
                                    </div>
                                ))}
                            </div>
                            <div className="bg-white border-t border-gray-200 p-4 pb-safe-bottom safe-area-bottom">
                                <button onClick={deleteHistoryOrder} className="w-full py-3 bg-red-50 text-red-600 font-bold rounded-xl border border-red-100">删除整单</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>