<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>智能出库管理 Pro V4</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. SheetJS (Excel导出) -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <!-- 4. HTML5-QRCode (作为兼容性降级方案) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #F2F2F7;
            color: #1C1C1E;
            overscroll-behavior: none;
        }
        
        /* 动画定义 */
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
        .animate-scale-up { animation: scaleUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .pt-safe-top { padding-top: env(safe-area-inset-top); }
        .pb-safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        /* 行高亮闪烁动画 */
        @keyframes flashRow {
            0% { background-color: rgba(59, 130, 246, 0.2); }
            50% { background-color: rgba(59, 130, 246, 0.1); }
            100% { background-color: transparent; }
        }
        .row-highlight { animation: flashRow 1s ease-out; }

        /* 扫描线动画 */
        @keyframes scanLine {
            0% { transform: translateY(0); opacity: 0.5; }
            50% { opacity: 1; }
            100% { transform: translateY(200px); opacity: 0.5; }
        }
        .scan-laser {
            width: 100%;
            height: 2px;
            background: #3b82f6;
            box-shadow: 0 0 4px #3b82f6;
            animation: scanLine 2s infinite linear;
        }

        /* 日历样式 */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; position: relative; font-size: 14px; font-weight: 500; color: #333; }
        .calendar-day.empty { background: transparent; pointer-events: none; }
        .calendar-day.active { background-color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .calendar-day.selected { border: 2px solid #2563EB; background-color: #EFF6FF; }
        .calendar-day.today { color: #2563EB; font-weight: 900; background-color: #EFF6FF; }
        .calendar-dot { width: 4px; height: 4px; border-radius: 50%; background-color: #2563EB; margin-top: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- 图标组件 (Lucide Style) ---
        const Icons = {
            Package: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>,
            Scan: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></svg>,
            Save: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
            History: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20v-6M6 20V10M18 20V4"/></svg>,
            Trash: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            Plus: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Minus: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            X: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Share: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>,
            Copy: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
            ChevronLeft: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>,
            ChevronRight: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>,
            Calendar: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            Info: ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>,
            AlertTriangle: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>,
            Zap: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
        };

        // --- 全屏扫描器组件 (双核引擎) ---
        const FullScreenScanner = ({ onScan, onClose, show }) => {
            const videoRef = useRef(null);
            const containerRef = useRef(null);
            const [engineType, setEngineType] = useState('初始化...');
            const html5QrCodeRef = useRef(null);
            const frameIdRef = useRef(null);
            const isNativeSupportedRef = useRef(false);

            useEffect(() => {
                if (!show) return;

                const startScanner = async () => {
                    // 1. 尝试检测原生 BarcodeDetector 支持 (Android Chrome / macOS Chrome)
                    if ('BarcodeDetector' in window) {
                        try {
                            const formats = await window.BarcodeDetector.getSupportedFormats();
                            if (formats.includes('qr_code') || formats.includes('ean_13')) {
                                isNativeSupportedRef.current = true;
                                setEngineType('Native Core');
                                await startNativeScanner();
                                return;
                            }
                        } catch (e) {
                            console.warn("Native check failed, fallback to WASM", e);
                        }
                    }

                    // 2. 降级方案: html5-qrcode (iOS / Firefox / Older devices)
                    setEngineType('Standard Core');
                    startWasmScanner();
                };

                startScanner();

                return () => {
                    stopNativeScanner();
                    stopWasmScanner();
                };
            }, [show]);

            // --- 引擎 A: Native BarcodeDetector ---
            const startNativeScanner = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } 
                    });
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        await videoRef.current.play();
                        
                        const detector = new window.BarcodeDetector({ formats: ['qr_code', 'ean_13', 'ean_8', 'code_128', 'code_39'] });
                        
                        const detectLoop = async () => {
                            if (!videoRef.current || videoRef.current.paused || videoRef.current.ended) return;
                            try {
                                const barcodes = await detector.detect(videoRef.current);
                                if (barcodes.length > 0) {
                                    onScan(barcodes[0].rawValue);
                                }
                            } catch (e) { /* ignore frame error */ }
                            frameIdRef.current = requestAnimationFrame(detectLoop);
                        };
                        detectLoop();
                    }
                } catch (err) {
                    console.error("Native camera error", err);
                    setEngineType('Error: Camera Access');
                    startWasmScanner(); // Fallback if getUserMedia fails
                }
            };

            const stopNativeScanner = () => {
                if (frameIdRef.current) cancelAnimationFrame(frameIdRef.current);
                if (videoRef.current && videoRef.current.srcObject) {
                    videoRef.current.srcObject.getTracks().forEach(t => t.stop());
                }
            };

            // --- 引擎 B: html5-qrcode (Fallback) ---
            const startWasmScanner = () => {
                const scanner = new Html5Qrcode("reader-container");
                html5QrCodeRef.current = scanner;
                
                const config = { fps: 15, qrbox: { width: 250, height: 250 }, aspectRatio: window.innerHeight/window.innerWidth };
                scanner.start({ facingMode: "environment" }, config, (text) => onScan(text), () => {})
                    .catch(err => {
                        console.error("WASM scanner failed", err);
                        // showToast("摄像头启动失败", "error");
                    });
            };

            const stopWasmScanner = () => {
                if (html5QrCodeRef.current) {
                    html5QrCodeRef.current.stop().then(() => html5QrCodeRef.current.clear()).catch(()=>{});
                }
            };

            if (!show) return null;

            return (
                <div className="fixed inset-0 z-[999] bg-black text-white flex flex-col">
                    {/* 顶部栏 */}
                    <div className="absolute top-0 left-0 right-0 p-4 pt-safe-top z-20 flex justify-between items-center bg-gradient-to-b from-black/60 to-transparent">
                        <button onClick={onClose} className="p-2 bg-white/20 rounded-full backdrop-blur-md">
                            <Icons.X size={24} />
                        </button>
                        <div className="text-xs font-mono opacity-60 bg-black/40 px-2 py-1 rounded">{engineType}</div>
                    </div>

                    {/* 视频容器 (Native) */}
                    {isNativeSupportedRef.current ? (
                        <video ref={videoRef} className="absolute inset-0 w-full h-full object-cover" playsInline muted></video>
                    ) : (
                        /* 视频容器 (WASM) */
                        <div id="reader-container" className="absolute inset-0 w-full h-full [&>video]:object-cover [&>video]:w-full [&>video]:h-full"></div>
                    )}

                    {/* 遮罩层 (实现中间透光效果) */}
                    <div className="absolute inset-0 pointer-events-none z-10 flex flex-col">
                        <div className="flex-1 bg-black/50"></div>
                        <div className="flex h-[250px] w-full">
                            <div className="flex-1 bg-black/50"></div>
                            <div className="w-[250px] h-[250px] border-2 border-blue-500 relative bg-transparent box-content">
                                {/* 扫描线 */}
                                <div className="scan-laser absolute top-0 left-0"></div>
                                {/* 四角装饰 */}
                                <div className="absolute top-0 left-0 w-4 h-4 border-t-4 border-l-4 border-blue-500 -mt-1 -ml-1"></div>
                                <div className="absolute top-0 right-0 w-4 h-4 border-t-4 border-r-4 border-blue-500 -mt-1 -mr-1"></div>
                                <div className="absolute bottom-0 left-0 w-4 h-4 border-b-4 border-l-4 border-blue-500 -mb-1 -ml-1"></div>
                                <div className="absolute bottom-0 right-0 w-4 h-4 border-b-4 border-r-4 border-blue-500 -mb-1 -mr-1"></div>
                            </div>
                            <div className="flex-1 bg-black/50"></div>
                        </div>
                        <div className="flex-1 bg-black/50 flex flex-col items-center pt-8">
                            <p className="text-white/90 text-sm font-medium tracking-wide">将条码/二维码放入框内</p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 通用确认弹窗 ---
        const ConfirmModal = ({ isOpen, title, content, onConfirm, onCancel, confirmText="确认", cancelText="取消", isDangerous=false }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center p-6 animate-fade-in">
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onClick={onCancel}></div>
                    <div className="bg-white rounded-2xl w-full max-w-xs p-6 relative z-10 shadow-2xl animate-scale-up">
                        <div className={`mx-auto w-12 h-12 rounded-full flex items-center justify-center mb-4 ${isDangerous ? 'bg-red-50 text-red-500' : 'bg-blue-50 text-blue-500'}`}>
                            {isDangerous ? <Icons.AlertTriangle /> : <Icons.Info />}
                        </div>
                        <h3 className="text-lg font-bold text-gray-900 text-center mb-2">{title}</h3>
                        <p className="text-sm text-gray-500 text-center mb-6 leading-relaxed">{content}</p>
                        <div className="flex gap-3">
                            <button onClick={onCancel} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl active:bg-gray-200 transition-colors text-sm">{cancelText}</button>
                            <button onClick={onConfirm} className={`flex-1 py-3 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform text-sm ${isDangerous ? 'bg-red-500 shadow-red-200' : 'bg-blue-600 shadow-blue-200'}`}>
                                {confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Toast 提示 ---
        const Toast = ({ show, message, type = 'success' }) => {
            if (!show) return null;
            return (
                <div className="fixed top-20 left-1/2 transform -translate-x-1/2 z-[1100] animate-fade-in pointer-events-none">
                    <div className={`px-5 py-2.5 rounded-full shadow-xl flex items-center gap-2 text-sm font-bold text-white backdrop-blur-md ${type === 'success' ? 'bg-black/80' : 'bg-red-500/90'}`}>
                        {type === 'success' ? <Icons.Info size={16}/> : <Icons.AlertTriangle size={16}/>}
                        {message}
                    </div>
                </div>
            );
        };

        const App = () => {
            // --- 数据 ---
            const [currentOrder, setCurrentOrder] = useState(() => {
                try { return JSON.parse(localStorage.getItem('inventory_current_order')) || []; } catch { return []; }
            });
            const [orderHistory, setOrderHistory] = useState(() => {
                try { return JSON.parse(localStorage.getItem('inventory_history')) || []; } catch { return []; }
            });
            const [productDB, setProductDB] = useState(() => {
                try { return JSON.parse(localStorage.getItem('inventory_db')) || {}; } catch { return {}; }
            });

            // --- 状态 ---
            const [activeTab, setActiveTab] = useState('current');
            const [showScanner, setShowScanner] = useState(false);
            const [lastScannedCode, setLastScannedCode] = useState(null);
            const [manualCode, setManualCode] = useState("");
            
            const [modalConfig, setModalConfig] = useState({ isOpen: false });
            const [toastConfig, setToastConfig] = useState({ show: false, message: '', type: 'success' });
            
            // 历史查看状态
            const [currentDate, setCurrentDate] = useState(new Date()); 
            const [viewingOrderId, setViewingOrderId] = useState(null); 

            const lastScanTimeRef = useRef(0);

            // --- 持久化 ---
            useEffect(() => { localStorage.setItem('inventory_current_order', JSON.stringify(currentOrder)); }, [currentOrder]);
            useEffect(() => { localStorage.setItem('inventory_history', JSON.stringify(orderHistory)); }, [orderHistory]);
            useEffect(() => { localStorage.setItem('inventory_db', JSON.stringify(productDB)); }, [productDB]);

            const showToast = (msg, type = 'success') => {
                setToastConfig({ show: true, message: msg, type });
                setTimeout(() => setToastConfig(prev => ({ ...prev, show: false })), 2000);
            };

            // --- 业务逻辑 ---
            const addItemToOrder = (code) => {
                const now = Date.now();
                const existingIndex = currentOrder.findIndex(item => item.code === code);

                if (existingIndex !== -1) {
                    const newOrder = [...currentOrder];
                    newOrder[existingIndex].qty += 1;
                    setCurrentOrder(newOrder);
                } else {
                    const productInfo = productDB[code] || { name: "", price: 0 };
                    const newItem = { id: now, code: code, name: productInfo.name, price: productInfo.price, qty: 1 };
                    setCurrentOrder([newItem, ...currentOrder]);
                }
                
                setLastScannedCode(code);
                setTimeout(() => setLastScannedCode(null), 1000);
                
                // 震动反馈 (如果设备支持)
                if (navigator.vibrate) navigator.vibrate(50);
                
                // 声音反馈
                const audio = new Audio('https://www.soundjay.com/buttons/sounds/button-3.mp3');
                audio.play().catch(()=>{});
                
                showToast(`已添加: ${code}`);
            };

            const onScanSuccess = (decodedText) => {
                const now = Date.now();
                // 1.5秒防抖
                if (now - lastScanTimeRef.current < 1500) return; 
                lastScanTimeRef.current = now;
                addItemToOrder(decodedText);
            };

            const updateCurrentItem = (id, field, value) => {
                setCurrentOrder(prev => prev.map(item => {
                    if (item.id === id) {
                        const updated = { ...item, [field]: value };
                        if (field === 'name' || field === 'price') {
                            setTimeout(() => {
                                setProductDB(prevDB => ({ ...prevDB, [updated.code]: { name: updated.name, price: Number(updated.price) } }));
                            }, 0);
                        }
                        return updated;
                    }
                    return item;
                }));
            };

            const deleteCurrentItem = (id) => {
                setModalConfig({
                    isOpen: true,
                    title: "删除商品",
                    content: "确定移除此商品吗？",
                    isDangerous: true,
                    onConfirm: () => {
                        setCurrentOrder(prev => prev.filter(item => item.id !== id));
                        setModalConfig({ isOpen: false });
                        showToast("已移除");
                    },
                    onCancel: () => setModalConfig({ isOpen: false })
                });
            };

            const saveCurrentOrder = () => {
                if (currentOrder.length === 0) return showToast("清单为空", "error");
                setModalConfig({
                    isOpen: true,
                    title: "确认归档",
                    content: `共 ${currentOrder.length} 项商品，即将保存。`,
                    onConfirm: () => {
                        const totalQty = currentOrder.reduce((sum, i) => sum + i.qty, 0);
                        const totalAmount = currentOrder.reduce((sum, i) => sum + (i.price * i.qty), 0);
                        const newHistoryRecord = { id: Date.now(), date: Date.now(), totalQty, totalAmount, items: [...currentOrder] };
                        setOrderHistory([newHistoryRecord, ...orderHistory]);
                        setCurrentOrder([]);
                        setShowScanner(false);
                        setModalConfig({ isOpen: false });
                        showToast("归档成功");
                    },
                    onCancel: () => setModalConfig({ isOpen: false })
                });
            };

            // --- 历史记录编辑 ---
            const viewingOrder = useMemo(() => orderHistory.find(o => o.id === viewingOrderId), [orderHistory, viewingOrderId]);

            const updateHistoryItem = (itemId, field, value) => {
                if (!viewingOrder) return;
                const updatedItems = viewingOrder.items.map(item => item.id === itemId ? { ...item, [field]: value } : item);
                const totalQty = updatedItems.reduce((s, i) => s + Number(i.qty), 0);
                const totalAmount = updatedItems.reduce((s, i) => s + (Number(i.price) * Number(i.qty)), 0);
                setOrderHistory(prev => prev.map(o => o.id === viewingOrderId ? { ...o, items: updatedItems, totalQty, totalAmount } : o));
            };

            const deleteHistoryItem = (itemId) => {
                setModalConfig({
                    isOpen: true, title: "删除历史条目", content: "确定移除此商品吗？", isDangerous: true,
                    onConfirm: () => {
                        if (!viewingOrder) return;
                        const updatedItems = viewingOrder.items.filter(item => item.id !== itemId);
                        const totalQty = updatedItems.reduce((s, i) => s + Number(i.qty), 0);
                        const totalAmount = updatedItems.reduce((s, i) => s + (Number(i.price) * Number(i.qty)), 0);
                        setOrderHistory(prev => prev.map(o => o.id === viewingOrderId ? { ...o, items: updatedItems, totalQty, totalAmount } : o));
                        setModalConfig({ isOpen: false });
                        showToast("已删除");
                    },
                    onCancel: () => setModalConfig({ isOpen: false })
                });
            };

            const deleteHistoryOrder = () => {
                setModalConfig({
                    isOpen: true, title: "删除整单", content: "确定彻底删除这条记录吗？无法撤销。", isDangerous: true, confirmText: "删除",
                    onConfirm: () => {
                        setOrderHistory(prev => prev.filter(o => o.id !== viewingOrderId));
                        setViewingOrderId(null);
                        setModalConfig({ isOpen: false });
                        showToast("记录已删除");
                    },
                    onCancel: () => setModalConfig({ isOpen: false })
                });
            };

            // --- 导出 ---
            const copyOrderText = (orderItems, dateStr = "当前") => {
                if (!orderItems || orderItems.length === 0) return showToast("无数据", "error");
                const tQty = orderItems.reduce((s, i) => s + Number(i.qty), 0);
                const tAmt = orderItems.reduce((s, i) => s + (Number(i.price) * Number(i.qty)), 0);
                let text = `出库单 (${dateStr})\n----------------\n`;
                orderItems.forEach(item => { text += `${item.name || '未命名'} (${item.code})\n   x${item.qty}   ¥${(item.price * item.qty).toFixed(2)}\n`; });
                text += `----------------\n总数量: ${tQty}\n总金额: ¥${tAmt.toFixed(2)}\n`;
                const textarea = document.createElement('textarea'); textarea.value = text; document.body.appendChild(textarea); textarea.select();
                try { document.execCommand('copy'); showToast("已复制"); } catch (err) { showToast("复制失败", "error"); }
                document.body.removeChild(textarea);
            };

            const exportOrderExcel = (orderItems, filename) => {
                if (!orderItems || orderItems.length === 0) return showToast("无数据", "error");
                const data = orderItems.map(item => ({ "条码": item.code, "商品名称": item.name, "单价": item.price, "数量": item.qty, "小计": (item.price * item.qty).toFixed(2) }));
                data.push({ "条码": "总计", "数量": orderItems.reduce((s, i)=>s+Number(i.qty),0), "小计": orderItems.reduce((s,i)=>s+(Number(i.price)*Number(i.qty)),0).toFixed(2) });
                const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                XLSX.writeFile(wb, filename + ".xlsx");
            };

            // --- 日历 ---
            const calendarData = useMemo(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDayWeek = new Date(year, month, 1).getDay();
                const days = [];
                for(let i=0; i<firstDayWeek; i++) days.push({ empty: true });
                for(let d=1; d<=daysInMonth; d++) {
                    const dateObj = new Date(year, month, d);
                    const dayStart = dateObj.getTime();
                    const dayEnd = new Date(year, month, d, 23, 59, 59).getTime();
                    const dayRecords = orderHistory.filter(r => r.date >= dayStart && r.date <= dayEnd);
                    days.push({ day: d, date: dateObj, hasData: dayRecords.length > 0 });
                }
                return days;
            }, [currentDate, orderHistory]);

            const currentTotalAmount = currentOrder.reduce((sum, item) => sum + (item.price * item.qty), 0);

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col pb-20 max-w-lg mx-auto shadow-2xl relative overflow-hidden">
                    <ConfirmModal {...modalConfig} />
                    <Toast {...toastConfig} />
                    <FullScreenScanner show={showScanner} onScan={onScanSuccess} onClose={() => setShowScanner(false)} />

                    <div className="bg-white border-b border-gray-200 sticky top-0 z-30 pt-safe-top">
                        <div className="px-4 h-14 flex items-center justify-between">
                            <h1 className="font-bold text-lg text-slate-800">{activeTab === 'current' ? '出库开单' : '历史记录'}</h1>
                            {activeTab === 'current' && (
                                <button onClick={() => setShowScanner(true)} className="flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-bold transition-colors bg-blue-100 text-blue-600">
                                    <Icons.Scan size={16} /> 开启扫码
                                </button>
                            )}
                            {activeTab === 'history' && (
                                <button onClick={() => setCurrentDate(new Date())} className="text-xs font-bold bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full">回到今天</button>
                            )}
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto">
                        {activeTab === 'current' && (
                            <div className="flex flex-col min-h-full">
                                <div className="p-3 bg-white border-b border-gray-100 flex gap-2">
                                    <input type="text" className="flex-1 bg-gray-100 rounded-lg px-3 text-sm outline-none h-10" placeholder="扫描或手动输入条码..." value={manualCode} onChange={e => setManualCode(e.target.value)} onKeyDown={e => {if(e.key === 'Enter' && manualCode) {addItemToOrder(manualCode); setManualCode('');}}} />
                                    <button onClick={() => {if(manualCode) {addItemToOrder(manualCode); setManualCode('');}}} className="bg-blue-600 text-white px-4 h-10 rounded-lg font-bold text-sm shadow-sm">添加</button>
                                </div>
                                <div className="p-3 space-y-3 pb-32">
                                    {currentOrder.length === 0 ? <div className="text-center py-10 text-gray-400 text-sm">暂无商品<br/>请开启扫码或手动添加</div> : currentOrder.map(item => (
                                        <div key={item.id} className={`bg-white rounded-xl p-3 shadow-sm border border-gray-100 transition-colors duration-500 ${lastScannedCode === item.code ? 'row-highlight ring-2 ring-blue-400 border-blue-400' : ''}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <div className="flex-1 mr-2"><input type="text" className="font-bold text-base w-full outline-none bg-transparent text-slate-800" placeholder="点击输入名称..." value={item.name} onChange={e => updateCurrentItem(item.id, 'name', e.target.value)} /><div className="text-xs text-gray-400 font-mono mt-0.5">{item.code}</div></div>
                                                <button onClick={() => deleteCurrentItem(item.id)} className="text-gray-300 p-1 hover:text-red-500"><Icons.Trash /></button>
                                            </div>
                                            <div className="flex justify-between items-center bg-gray-50 p-2 rounded-lg">
                                                <div className="flex items-center gap-1"><span className="text-gray-400 text-xs">¥</span><input type="number" className="w-16 bg-transparent font-bold text-slate-700 outline-none" value={item.price} onChange={e => updateCurrentItem(item.id, 'price', e.target.value)} placeholder="0.00" /></div>
                                                <div className="flex items-center gap-3"><button className="w-6 h-6 bg-white border rounded flex items-center justify-center active:bg-gray-200" onClick={() => updateCurrentItem(item.id, 'qty', Math.max(1, item.qty - 1))}><Icons.Minus size={14}/></button><span className="font-bold text-lg w-6 text-center">{item.qty}</span><button className="w-6 h-6 bg-white border rounded flex items-center justify-center active:bg-gray-200" onClick={() => updateCurrentItem(item.id, 'qty', item.qty + 1)}><Icons.Plus size={14}/></button></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="p-4 space-y-4 pb-24 animate-fade-in">
                                <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                                    <div className="flex justify-between items-center mb-4">
                                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))} className="p-2 text-gray-400"><Icons.ChevronLeft /></button>
                                        <span className="font-bold text-lg">{currentDate.getFullYear()}年 {currentDate.getMonth() + 1}月</span>
                                        <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))} className="p-2 text-gray-400"><Icons.ChevronRight /></button>
                                    </div>
                                    <div className="grid grid-cols-7 mb-2 text-center text-xs text-gray-400"><div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div></div>
                                    <div className="calendar-grid">
                                        {calendarData.map((d, i) => (d.empty ? <div key={i} className="calendar-day empty"></div> : <div key={i} className={`calendar-day ${d.hasData?'active':''} ${new Date().toDateString()===d.date.toDateString()?'today':''}`}><span>{d.day}</span>{d.hasData && <div className="calendar-dot absolute bottom-2"></div>}</div>))}
                                    </div>
                                </div>
                                <div className="space-y-3">
                                    <h3 className="text-xs font-bold text-gray-400 pl-1">近期记录</h3>
                                    {orderHistory.sort((a,b)=>b.date-a.date).map(order => (
                                        <div key={order.id} onClick={() => setViewingOrderId(order.id)} className="bg-white rounded-xl p-4 shadow-sm border border-gray-100 active:bg-gray-50 transition-colors cursor-pointer">
                                            <div className="flex justify-between items-center mb-2"><span className="font-bold text-slate-700 text-sm">{new Date(order.date).toLocaleString()}</span><Icons.ChevronRight className="text-gray-300" size={16} /></div>
                                            <div className="flex justify-between items-center text-xs text-gray-500 bg-gray-50 p-2 rounded-lg"><span>共 {order.totalQty} 件</span><span className="font-bold text-slate-800 text-sm">¥ {order.totalAmount.toFixed(2)}</span></div>
                                        </div>
                                    ))}
                                    {orderHistory.length === 0 && <div className="text-center text-gray-400 text-xs py-4">暂无历史记录</div>}
                                </div>
                            </div>
                        )}
                    </div>

                    {activeTab === 'current' && (
                        <div className="absolute bottom-16 left-4 right-4 bg-white/90 backdrop-blur-md border border-gray-200 shadow-lg rounded-2xl p-3 pb-safe-bottom z-40">
                            <div className="flex justify-between items-center mb-3 px-1"><span className="text-sm text-gray-500 font-medium">本单合计</span><span className="text-xl font-bold text-red-600">¥ {currentTotalAmount.toFixed(2)}</span></div>
                            <div className="flex gap-2">
                                <button onClick={() => copyOrderText(currentOrder)} className="flex-1 py-3 bg-blue-50 text-blue-600 font-bold rounded-xl flex items-center justify-center gap-1 text-sm"><Icons.Copy size={16} /> 复制</button>
                                <button onClick={() => exportOrderExcel(currentOrder, `出库单_${Date.now()}`)} className="w-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center"><Icons.Share size={16} /></button>
                                <button onClick={saveCurrentOrder} className="flex-[1.5] py-3 bg-blue-600 text-white font-bold rounded-xl flex items-center justify-center gap-1 shadow-lg shadow-blue-500/30 text-sm"><Icons.Save size={16} /> 归档</button>
                            </div>
                        </div>
                    )}

                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 pb-safe-bottom z-50 h-16 flex items-center justify-around max-w-lg mx-auto">
                        <button onClick={() => setActiveTab('current')} className={`flex flex-col items-center gap-1 w-16 ${activeTab === 'current' ? 'text-blue-600' : 'text-gray-400'}`}><Icons.Package size={24} /><span className="text-[10px] font-medium">开单</span></button>
                        <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center gap-1 w-16 ${activeTab === 'history' ? 'text-blue-600' : 'text-gray-400'}`}><Icons.History size={24} /><span className="text-[10px] font-medium">记录</span></button>
                    </div>

                    {viewingOrder && (
                        <div className="fixed inset-0 z-[60] bg-gray-100 flex flex-col animate-slide-up">
                            <div className="bg-white px-4 h-14 border-b flex items-center justify-between pt-safe-top shrink-0">
                                <button onClick={() => setViewingOrderId(null)} className="text-blue-600 font-bold text-sm flex items-center"><Icons.ChevronLeft size={20}/> 返回</button>
                                <span className="font-bold text-sm">单据详情 (可编辑)</span>
                                <div className="flex gap-3"><button onClick={() => copyOrderText(viewingOrder.items, new Date(viewingOrder.date).toLocaleString())} className="text-blue-600"><Icons.Copy size={20}/></button><button onClick={() => exportOrderExcel(viewingOrder.items, `历史出库单_${viewingOrder.id}`)} className="text-green-600"><Icons.Share size={20}/></button></div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 pb-32">
                                <div className="space-y-3">
                                    {viewingOrder.items.map((item) => (
                                        <div key={item.id} className="bg-white rounded-xl p-3 shadow-sm border border-gray-100">
                                            <div className="flex justify-between items-start mb-2">
                                                <div className="flex-1 mr-2"><input type="text" className="font-bold text-base w-full outline-none bg-transparent text-slate-800" value={item.name} onChange={e => updateHistoryItem(item.id, 'name', e.target.value)} /><div className="text-xs text-gray-400 font-mono mt-0.5">{item.code}</div></div>
                                                <button onClick={() => deleteHistoryItem(item.id)} className="text-gray-300 p-1 hover:text-red-500"><Icons.Trash size={18}/></button>
                                            </div>
                                            <div className="flex justify-between items-center bg-gray-50 p-2 rounded-lg">
                                                <div className="flex items-center gap-1"><span className="text-gray-400 text-xs">¥</span><input type="number" className="w-16 bg-transparent font-bold text-slate-700 outline-none" value={item.price} onChange={e => updateHistoryItem(item.id, 'price', e.target.value)} /></div>
                                                <div className="flex items-center gap-3"><button className="w-6 h-6 bg-white border rounded flex items-center justify-center active:bg-gray-200" onClick={() => updateHistoryItem(item.id, 'qty', Math.max(1, item.qty - 1))}><Icons.Minus size={14}/></button><span className="font-bold text-lg w-6 text-center">{item.qty}</span><button className="w-6 h-6 bg-white border rounded flex items-center justify-center active:bg-gray-200" onClick={() => updateHistoryItem(item.id, 'qty', item.qty + 1)}><Icons.Plus size={14}/></button></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-white border-t border-gray-200 p-4 pb-safe-bottom safe-area-bottom">
                                <div className="flex justify-between items-center mb-4"><span className="text-gray-500 text-sm">总计金额</span><span className="text-xl font-bold text-blue-600">¥ {viewingOrder.totalAmount.toFixed(2)}</span></div>
                                <button onClick={deleteHistoryOrder} className="w-full py-3 bg-red-50 text-red-600 font-bold rounded-xl border border-red-100 active:bg-red-100 transition-colors">删除整张单据</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>